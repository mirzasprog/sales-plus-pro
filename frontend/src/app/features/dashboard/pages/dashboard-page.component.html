<section class="dashboard" *ngIf="summary$ | async as summary">
  <header class="dashboard__header" *ngIf="filterOptions$ | async as options">
    <div>
      <p class="eyebrow">Kontrolna ploča</p>
      <h1>Pregled zauzetosti i prihoda</h1>
      <p class="muted">Filtriraj KPI pokazatelje prema regiji, objektu ili partneru i uoči trendove kroz vrijeme.</p>
    </div>
    <form class="filters" [formGroup]="filtersForm">
      <label class="filter">
        <span>Regija</span>
        <select formControlName="region">
          <option [ngValue]="null">Sve regije</option>
          <option *ngFor="let region of options.regions" [value]="region">{{ region }}</option>
        </select>
      </label>
      <label class="filter">
        <span>Objekt</span>
        <select formControlName="store">
          <option [ngValue]="null">Svi objekti</option>
          <option *ngFor="let store of options.stores" [value]="store.id">{{ store.name }}</option>
        </select>
      </label>
      <label class="filter">
        <span>Dobavljač</span>
        <select formControlName="supplier">
          <option [ngValue]="null">Svi dobavljači</option>
          <option *ngFor="let supplier of options.suppliers" [value]="supplier.id">{{ supplier.name }}</option>
        </select>
      </label>
      <label class="filter">
        <span>Pozicija</span>
        <select formControlName="positionType">
          <option [ngValue]="null">Sve pozicije</option>
          <option *ngFor="let type of options.positionTypes" [value]="type">{{ type }}</option>
        </select>
      </label>
    </form>
  </header>

  <div class="kpi-grid">
    <app-kpi-card label="Ukupno pozicija" [value]="summary.totalPositions" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Slobodno" [value]="summary.availablePositions" accent="success" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Zauzeto" [value]="summary.occupiedPositions" accent="danger" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Rezervirano" [value]="summary.reservedPositions" accent="warning" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Ističe uskoro" [value]="summary.expiringSoonPositions" accent="warning" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Neaktivno" [value]="summary.inactivePositions" routerLink="/positions"></app-kpi-card>
    <app-kpi-card label="Ugovori koji ističu" [value]="summary.expiringContracts" routerLink="/suppliers"></app-kpi-card>
    <app-kpi-card label="Pokrivenost objekata" [value]="summary.coveragePercent + '%'" accent="success" routerLink="/stores"></app-kpi-card>
  </div>

  <div class="dashboard__grid">
    <div class="card">
      <h2>Status pozicija</h2>
      <ngx-charts-pie-chart
        *ngIf="summary$ | async as s"
        [results]="[
          { name: 'Slobodno', value: s.availablePositions },
          { name: 'Zauzeto', value: s.occupiedPositions },
          { name: 'Rezervirano', value: s.reservedPositions },
          { name: 'Ističe', value: s.expiringSoonPositions },
          { name: 'Neaktivno', value: s.inactivePositions }
        ]"
        [legend]="true"
        [animations]="true"
        [labels]="true"
      ></ngx-charts-pie-chart>
    </div>

    <div class="card card--wide" *ngIf="trend$ | async as trend">
      <header class="card__header">
        <h2>Mjesečni trend</h2>
        <p class="muted">Kretanje zauzetosti pozicija i prihoda od zakupa</p>
      </header>
      <ngx-charts-line-chart
        [scheme]="{ domain: ['#38bdf8', '#c084fc'] }"
        [results]="trend"
        [legend]="true"
        [autoScale]="true"
        [animations]="true"
        [showXAxisLabel]="true"
        [showYAxisLabel]="true"
        xAxisLabel="Mjesec"
        yAxisLabel="Vrijednost"
      ></ngx-charts-line-chart>
    </div>

    <div class="card" *ngIf="expiringContracts$ | async as expiring">
      <header class="card__header">
        <h2>Ugovori koji ističu (45 dana)</h2>
      </header>
      <div class="list">
        <div class="list__row" *ngFor="let contract of expiring">
          <div>
            <div class="title">{{ contract.supplier }}</div>
            <div class="muted">Rok: {{ contract.endDate | date }}</div>
          </div>
          <div>{{ contract.value | currency: 'EUR' }}</div>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="topSuppliers$ | async as suppliers">
      <header class="card__header">
        <h2>Top dobavljači</h2>
        <p class="muted">Po aktivnom zakupu</p>
      </header>
      <div class="list">
        <div class="list__row" *ngFor="let supplier of suppliers">
          <div>
            <div class="title">{{ supplier.name }}</div>
            <div class="muted">{{ supplier.category }}</div>
          </div>
          <div>{{ supplier.activeRevenue | currency: 'EUR' }}</div>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="storeCoverage$ | async as stores">
      <header class="card__header">
        <h2>Pokrivenost objekata</h2>
        <p class="muted">Prvih nekoliko objekata</p>
      </header>
      <div class="list">
        <div class="list__row" *ngFor="let store of stores">
          <div>
            <div class="title">{{ store.name }}</div>
            <div class="muted">{{ store.city }}</div>
          </div>
          <div class="pill">
            <span class="dot occupied"></span>{{ store.occupancy | number: '1.0-0' }}%
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
